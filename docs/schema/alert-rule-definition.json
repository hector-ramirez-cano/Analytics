{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",

  "required": [
    "severity", "target", "reduce-logic",
    "source", "predicates", "requires-ack", "id"
  ],

  "properties": {
    "id": {
      "type" : "integer",
      "minimum": 0
    },

    "name": {
      "type": "string",
      "minLength": 1
    },

    "severity": {
      "type": "string",
      "enum": [
        "emergency", "alert", "critical", "error",
        "warning", "notice", "info", "debug"
      ]
    },

    "requires-ack": {
      "type": "boolean"
    },

    "target": {
      "type": "integer",
      "minimum": 1
    },

    "reduce-logic": {
      "type": "string",
      "enum": ["and", "or", "any"]
    },

    "source": {
      "type": "string",
      "enum": ["facts", "syslog"]
    },

    "rule-type": {
      "type": ["string", "object"]
    },

    "predicates": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["left", "op", "right"],
        "properties": {
          "left": {
            "type": ["string", "number", "boolean", "null", "object", "array"]
          },
          "left-modifier": {
            "$ref": "#/OperationModifierDefinitions/Modifier"
          },

          "op": {
            "type": "string",
            "enum": [
              "more_than", "more_than_equal", "less_than",
              "less_than_equal", "equal", "not_equal", "contains"
            ]
          },

          "right": {
            "type": ["string", "number", "boolean", "null", "object", "array"]
          },
          "right-modifier": {
            "$ref": "#/OperationModifierDefinitions/Modifier"
          }
        },
        "additionalProperties": false
      }
    }
  },

  "additionalProperties": false,

  "OperationModifierDefinitions": {
    "Modifier": {
      "oneOf": [
        { "$ref": "#/OperationModifierDefinitions/Multi" },
        
        { "$ref": "#/OperationModifierDefinitions/Add" },
        { "$ref": "#/OperationModifierDefinitions/Mul" },
        { "$ref": "#/OperationModifierDefinitions/Mod" },
        { "$ref": "#/OperationModifierDefinitions/Rem" },
        { "$ref": "#/OperationModifierDefinitions/Pow" },

        { "$ref": "#/OperationModifierDefinitions/Append"   },
        { "$ref": "#/OperationModifierDefinitions/Prepend"  },
        { "$ref": "#/OperationModifierDefinitions/Trim"     },
        { "$ref": "#/OperationModifierDefinitions/Replace"  },
        { "$ref": "#/OperationModifierDefinitions/ReplaceN" },
        { "$ref": "#/OperationModifierDefinitions/Lower"    },
        { "$ref": "#/OperationModifierDefinitions/Upper"    }
      ]
    },

    "Multi": {
      "type": "object",
      "properties": {
        "Multi": {
          "type": "object",
          "required": ["first", "then"],
          "properties": {
            "first": { "$ref": "#/OperationModifierDefinitions/Modifier" },
            "then":  { "$ref": "#/OperationModifierDefinitions/Modifier" }
          },
          "additionalProperties": false
        }
      },
      "required": ["Multi"],
      "additionalProperties": false
    },

    "Add": {
      "type": "object",
      "properties": {
        "Add": { "type": "number" }
      },
      "required": ["Add"],
      "additionalProperties": false
    },

    "Mul": {
      "type": "object",
      "properties": {
        "Mul": { "type": "number" }
      },
      "required": ["Mul"],
      "additionalProperties": false
    },

    "Mod": {
      "type": "object",
      "properties": {
        "Mod": { "type": "integer" }
      },
      "required": ["Mod"],
      "additionalProperties": false
    },

    "Rem": {
      "type": "object",
      "properties": {
        "Rem": { "type": "number" }
      },
      "required": ["Rem"],
      "additionalProperties": false
    },

    "Pow": {
      "type": "object",
      "properties": {
        "Pow": { "type": "number" }
      },
      "required": ["Pow"],
      "additionalProperties": false
    },

    "Replace": {
      "type": "object",
      "properties": {
        "Replace": {
          "type": "object",
          "required": ["pattern", "with"],
          "properties": {
            "pattern": { "type": "string" },
            "with": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "required": ["Replace"],
      "additionalProperties": false
    },

    "ReplaceN": {
      "type": "object",
      "properties": {
        "ReplaceN": {
          "type": "object",
          "required": ["count", "pattern", "with"],
          "properties": {
            "count": { "type": "integer", "minimum": 0 },
            "pattern": { "type": "string" },
            "with": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "required": ["ReplaceN"],
      "additionalProperties": false
    },

    "Lower": {
      "type": "string",
      "enum": ["Lower"]
    },

    "Upper": {
      "type": "string",
      "enum": ["Upper"]
    },

    "Trim": {
      "type": "string",
      "enum": ["Trim"]
    },

    "Append": {
      "type": "object",
      "properties": {
        "Append": { "type": "string" }
      },
      "required": ["Append"],
      "additionalProperties": false
    },

    "Prepend": {
      "type": "object",
      "properties": {
        "Prepend": { "type": "string" }
      },
      "required": ["Prepend"],
      "additionalProperties": false
    }
  }
}
