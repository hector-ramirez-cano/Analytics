{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",

  "required": [
    "severity", "target", "reduce-logic",
    "source", "predicates", "requires-ack", "id"
  ],

  "properties": {
    "id": {
      "type" : "integer",
      "minimum": 0
    },

    "name": {
      "type": "string",
      "minLength": 1
    },

    "severity": {
      "type": "string",
      "enum": [
        "emergency", "alert", "critical", "error",
        "warning", "notice", "info", "debug"
      ]
    },

    "requires-ack": {
      "type": "boolean"
    },

    "target": {
      "type": "integer",
      "minimum": 1
    },

    "reduce-logic": {
      "type": "string",
      "enum": ["and", "or", "any"]
    },

    "source": {
      "type": "string",
      "enum": ["facts", "syslog"]
    },

    "rule-type": {
      "type": ["string", "object"]
    },

    "predicates": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["left", "op", "right"],
        "properties": {
          "left": {
            "type": ["string", "number", "boolean", "null", "object", "array"]
          },
          "left-modifier": {
            "$ref": "#/OperationModifierDefinitions/Modifier"
          },

          "op": {
            "type": "string",
            "enum": [
              "more_than", "more_than_equal", "less_than",
              "less_than_equal", "equal", "not_equal", "contains"
            ]
          },

          "right": {
            "type": ["string", "number", "boolean", "null", "object", "array"]
          },
          "right-modifier": {
            "$ref": "#/OperationModifierDefinitions/Modifier"
          }
        },
        "additionalProperties": false
      }
    }
  },

  "additionalProperties": false,

  "OperationModifierDefinitions": {
    "Modifier": {
      "oneOf": [
        { "$ref": "#/OperationModifierDefinitions/multi" },
        
        { "$ref": "#/OperationModifierDefinitions/add" },
        { "$ref": "#/OperationModifierDefinitions/mul" },
        { "$ref": "#/OperationModifierDefinitions/mod" },
        { "$ref": "#/OperationModifierDefinitions/rem" },
        { "$ref": "#/OperationModifierDefinitions/pow" },

        { "$ref": "#/OperationModifierDefinitions/truncate" },
        { "$ref": "#/OperationModifierDefinitions/ceil"     },
        { "$ref": "#/OperationModifierDefinitions/floor"    },
        { "$ref": "#/OperationModifierDefinitions/round"    },
        
        { "$ref": "#/OperationModifierDefinitions/bitwiseAnd"},
        { "$ref": "#/OperationModifierDefinitions/bitwiseOr"},
        { "$ref": "#/OperationModifierDefinitions/bitwiseXor"},
        { "$ref": "#/OperationModifierDefinitions/bitwiseLShift"},
        { "$ref": "#/OperationModifierDefinitions/bitwiseLRhift"},
        { "$ref": "#/OperationModifierDefinitions/bitwiseComplement"},


        { "$ref": "#/OperationModifierDefinitions/append"   },
        { "$ref": "#/OperationModifierDefinitions/prepend"  },
        { "$ref": "#/OperationModifierDefinitions/trim"     },
        { "$ref": "#/OperationModifierDefinitions/replace"  },
        { "$ref": "#/OperationModifierDefinitions/replacen" },
        { "$ref": "#/OperationModifierDefinitions/lower"    },
        { "$ref": "#/OperationModifierDefinitions/upper"    }
      ]
    },

    "multi": {
      "type": "object",
      "properties": {
        "multi": {
          "type": "object",
          "required": ["operations"],
          "properties": {
            "operations": { 
              "type": "array",
              "minLength" : 1,
              "properties": {
                "$ref": "#/OperationModifierDefinitions/Modifier"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["multi"],
      "additionalProperties": false
    },

    "add": {
      "type": "object",
      "properties": {
        "add": { "type": "number" }
      },
      "required": ["add"],
      "additionalProperties": false
    },

    "mul": {
      "type": "object",
      "properties": {
        "mul": { "type": "number" }
      },
      "required": ["mul"],
      "additionalProperties": false
    },

    "mod": {
      "type": "object",
      "properties": {
        "mod": { "type": "integer" }
      },
      "required": ["mod"],
      "additionalProperties": false
    },

    "rem": {
      "type": "object",
      "properties": {
        "rem": { "type": "number" }
      },
      "required": ["rem"],
      "additionalProperties": false
    },

    "pow": {
      "type": "object",
      "properties": {
        "pow": { "type": "number" }
      },
      "required": ["pow"],
      "additionalProperties": false
    },

    "truncate": {
      "type": "object",
      "properties": {
        "truncate": { "type": "null" }
      },
      "required": ["truncate"],
      "additionalProperties": false
    },

    "ceil": {
      "type": "object",
      "properties": {
        "ceil": { "type": "null" }
      },
      "required": ["ceil"],
      "additionalProperties": false
    },

    "floor": {
      "type": "object",
      "properties": {
        "floor": { "type": "null" }
      },
      "required": ["floor"],
      "additionalProperties": false
    },

    "round": {
      "type": "object",
      "properties": {
        "round": { "type": "null" }
      },
      "required": ["round"],
      "additionalProperties": false
    },

    "bitwiseAnd": {
      "type": "object",
      "properties": {
        "bitwiseAnd": { "type": "integer" }
      },
      "required": ["bitwiseAnd"],
      "additionalProperties": false
    },

    "bitwiseOr": {
      "type": "object",
      "properties": {
        "bitwiseOr": { "type": "integer" }
      },
      "required": ["bitwiseOr"],
      "additionalProperties": false
    },

    "bitwiseXor": {
      "type": "object",
      "properties": {
        "bitwiseXor": { "type": "integer" }
      },
      "required": ["bitwiseXor"],
      "additionalProperties": false
    },

    "bitwiseLShift": {
      "type": "object",
      "properties": {
        "bitwiseLShift": { "type": "integer", "minimum": 1, "maximum": 64}
      },
      "required": ["bitwiseLShift"],
      "additionalProperties": false
    },
    "bitwiseRShift": {
      "type": "object",
      "properties": {
        "bitwiseRShift": { "type": "integer", "minimum": 1, "maximum": 64}
      },
      "required": ["bitwiseRShift"],
      "additionalProperties": false
    },

    "bitwiseComplement": {
      "type": "object",
      "properties": {
        "bitwiseComplement": { "type": "null" }
      },
      "required": ["bitwiseComplement"],
      "additionalProperties": false
    },

    "replace": {
      "type": "object",
      "properties": {
        "replace": {
          "type": "object",
          "required": ["pattern", "with"],
          "properties": {
            "pattern": { "type": "string" },
            "with": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "required": ["replace"],
      "additionalProperties": false
    },

    "replacen": {
      "type": "object",
      "properties": {
        "replacen": {
          "type": "object",
          "required": ["count", "pattern", "with"],
          "properties": {
            "count": { "type": "integer", "minimum": 0 },
            "pattern": { "type": "string" },
            "with": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "required": ["replacen"],
      "additionalProperties": false
    },

    "lower": {
      "type": "string",
      "enum": ["lower"]
    },

    "upper": {
      "type": "string",
      "enum": ["upper"]
    },

    "trim": {
      "type": "string",
      "enum": ["trim"]
    },

    "append": {
      "type": "object",
      "properties": {
        "append": { "type": "string" }
      },
      "required": ["append"],
      "additionalProperties": false
    },

    "prepend": {
      "type": "object",
      "properties": {
        "prepend": { "type": "string" }
      },
      "required": ["prepend"],
      "additionalProperties": false
    }
  }
}
